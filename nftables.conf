#!/usr/sbin/nft -f
# https://github.com/jidhub/nftablesBan 20251105
#
flush ruleset
table ip filter {
    # ip tests are logged for one hour in nine buckets, write in first free bucket
    set i1 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i2 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i3 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i4 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i5 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i6 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i7 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i8 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i9 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set tcp_ports_used { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_used { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ports_tested { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_tested { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_sports_tested { typeof tcp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_sports_tested { typeof udp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ports_contacted { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_contacted { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ip_contacted { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ip_contacted { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ip_contacted { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set blackhole_ipv4 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; } # to query it, use nft list set ip dev blackhole_ipv4

	chain input {
		type filter hook input priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		limit rate over 20/hour add @tcp_ports_used { tcp dport } counter # tcp port statistics in hours with more than 20 test.
		limit rate over 20/hour add @udp_ports_used { udp dport } counter # udp port statistics in hours with more than 20 test.
		ip saddr @blackhole_ipv4 counter drop # IP already flagged as black hole.
		tcp dport 22 ct state new counter goto newssh
		ip saddr != @i1 add @i1 { ip saddr } counter drop
		ip saddr != @i2 add @i2 { ip saddr } counter drop
		ip saddr != @i3 add @i3 { ip saddr } counter drop
		ip saddr != @i4 add @i4 { ip saddr } counter drop
		ip saddr != @i5 add @i5 { ip saddr } counter drop
		ip saddr != @i6 add @i6 { ip saddr } counter drop
		ip saddr != @i7 add @i7 { ip saddr } counter drop
		ip saddr != @i8 add @i8 { ip saddr } counter drop
		ip saddr != @i9 add @i9 { ip saddr } counter drop
		counter goto logandblackhole
	}

	chain newssh { # any IP is allowed nine tests in last hours before blackhole_ipv4. We only accept nine new ssh connections for any IP.
		ip saddr != @i1 add @i1 { ip saddr } counter accept
		ip saddr != @i2 add @i2 { ip saddr } counter accept
		ip saddr != @i3 add @i3 { ip saddr } counter accept
		ip saddr != @i4 add @i4 { ip saddr } counter accept
		ip saddr != @i5 add @i5 { ip saddr } counter accept
		ip saddr != @i6 add @i6 { ip saddr } counter accept
		ip saddr != @i7 add @i7 { ip saddr } counter accept
		ip saddr != @i8 add @i8 { ip saddr } counter accept
		ip saddr != @i9 add @i9 { ip saddr } counter accept
		counter goto logandblackhole
	}

	chain logandblackhole { # log the IP for 48h, and log the ports with at most same duration but overwritten when another IP is blackholed for the same port.
		add @tcp_ports_tested { tcp dport } counter # tcp port statistics from hosts making more than 9 tests in last hour
		add @udp_ports_tested { udp dport } counter # udp port statistics from hosts making more than 9 tests in last hour
		add @tcp_sports_tested { tcp sport } counter # tcp source port statistics from hosts making more than 9 tests in last hour
		add @udp_sports_tested { udp sport } counter # udp source port statistics from hosts making more than 9 tests in last hour
		add @blackhole_ipv4 { ip saddr } counter drop # now only those already in the nine sets remain, adding them to blackhole_ipv4
	}

	chain forward {
		type filter hook forward priority 0;
	}

	chain output {
		type filter hook output priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		add @tcp_ports_contacted { tcp dport } add @tcp_ip_contacted { ip daddr } counter accept # output port statistics
		add @udp_ports_contacted { udp dport } add @udp_ip_contacted { ip daddr } counter accept # output port statistics
		add @ip_contacted { ip daddr } # output host statistics
	}
}
table ip6 filter {
    set i16 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i26 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i36 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i46 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i56 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i66 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i76 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i86 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set i96 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set blackhole_ipv6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ports_used6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_used6 { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ports_tested6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_tested6 { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_sports_tested6 { typeof tcp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_sports_tested6 { typeof udp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set tcp_ports_contacted6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set udp_ports_contacted6 { typeof udp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ip_contacted6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 48h; }

	chain input {
		type filter hook input priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-request, echo-reply, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, 148, 149 } counter accept # ICMPv6 packets which must not be dropped, see https://tools.ietf.org/html/rfc4890#section-4.4.1
		ip6 saddr fe80::/10 icmpv6 type { 130, 131, 132, 143, 151, 152, 153 } counter accept
		limit rate over 20/hour add @tcp_ports_used6 { tcp dport } counter # tcp port statistics in hours with more than 20 test.
		limit rate over 20/hour add @udp_ports_used6 { udp dport } counter # udp port statistics in hours with more than 20 test.
		ip6 saddr & ffff:ffff:ffff:ffff:: @blackhole_ipv6 counter drop # IP already flagged as black hole.
		tcp dport 22 ct state new counter goto newssh
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i16 add @i16 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i26 add @i26 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i36 add @i36 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i46 add @i46 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i56 add @i56 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i66 add @i66 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i76 add @i76 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i86 add @i86 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i96 add @i96 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter drop
		counter goto logandblackhole
	}

	chain newssh {
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i16 add @i16 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept # any IPv6 range is allowed nine tests in last hours before blackhole_ipv6. We only accept nine new ssh connections for any IPv6 range.
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i26 add @i26 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i36 add @i36 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i46 add @i46 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i56 add @i56 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i66 add @i66 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i76 add @i76 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i86 add @i86 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr & ffff:ffff:ffff:ffff:: != @i96 add @i96 { ip6 saddr & ffff:ffff:ffff:ffff:: } counter accept
		counter goto logandblackhole
	}

	chain logandblackhole { # log the IP6q range for 48h, and log the ports with at most same duration but overwritten when another IP6 range is blackholed for the same port.
		add @tcp_ports_tested6 { tcp dport } counter # tcp port statistics from IPv6 ranges making more than 9 tests in last hour
		add @udp_ports_tested6 { udp dport } counter # udp port statistics from IPv6 ranges making more than 9 tests in last hour
		add @tcp_sports_tested6 { tcp sport } counter # tcp source port statistics from IPv6 ranges making more than 9 tests in last hour
		add @udp_sports_tested6 { udp sport } counter # udp source port statistics from IPv6 ranges making more than 9 tests in last hour
		add @blackhole_ipv6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop # now only those already in the nine sets remain, adding them to blackhole_ipv6
	}
	chain forward {
		type filter hook forward priority 0;
	}
	chain output {
		type filter hook output priority 0;
		add @tcp_ports_contacted6 { tcp dport } counter # tcp output port statistics
		add @udp_ports_contacted6 { udp dport } counter # udp output port statistics
		add @ip_contacted6 { ip6 daddr } # output port statistics
	}
}
