#!/usr/sbin/nft -f

# https://github.com/jidhub/nftablesBan 20251105
#
flush ruleset

table ip filter {
    # ip tests are logged for one hour in nine buckets, write in first free bucket
    set test1_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test2_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test3_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test4_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test5_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test6_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test7_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test8_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test9_ip { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set ports_used { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ports_tested { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set sports_tested { typeof tcp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ports_contacted { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ip_contacted { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set blackhole_ipv4 { type ipv4_addr; flags dynamic, timeout; size 65536; timeout 48h; } # to query it, use nft list set ip dev blackhole_ipv4

	chain input {
		type filter hook input priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		limit rate over 20/hour add @ports_used { tcp dport } counter # port statistics in hours with more than 20 test.
		ip saddr @blackhole_ipv4 counter drop # IP already flagged as black hole.
		tcp dport 22 ct state new ip saddr != @test1_ip add @test1_ip { ip saddr } counter accept # any IP is allowed nine tests in last hours before blackhole_ipv4. We only accept nine new ssh connections for any IP.
		ip saddr != @test1_ip add @test1_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test2_ip add @test2_ip { ip saddr } counter accept
		ip saddr != @test2_ip add @test2_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test3_ip add @test3_ip { ip saddr } counter accept
		ip saddr != @test3_ip add @test3_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test4_ip add @test4_ip { ip saddr } counter accept
		ip saddr != @test4_ip add @test4_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test5_ip add @test5_ip { ip saddr } counter accept
		ip saddr != @test5_ip add @test5_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test6_ip add @test6_ip { ip saddr } counter accept
		ip saddr != @test6_ip add @test6_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test7_ip add @test7_ip { ip saddr } counter accept
		ip saddr != @test7_ip add @test7_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test8_ip add @test8_ip { ip saddr } counter accept
		ip saddr != @test8_ip add @test8_ip { ip saddr } counter drop
		tcp dport 22 ct state new ip saddr != @test9_ip add @test9_ip { ip saddr } counter accept
		ip saddr != @test9_ip add @test9_ip { ip saddr } counter drop
		add @ports_tested { tcp dport } counter # port statistics from hosts making more than 9 tests in last hour
		add @sports_tested { tcp sport } counter # source port statistics from hosts making more than 9 tests in last hour
		add @blackhole_ipv4 { ip saddr } counter drop # now only those already in the nine sets remain, adding them to blackhole_ipv4
    }
	chain forward {
		type filter hook forward priority 0;
	}
	chain output {
		type filter hook output priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		add @ports_contacted { tcp dport } counter # output port statistics
		add @ip_contacted { ip daddr } # output host statistics
	}
}
table ip6 filter {
    set test1_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test2_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test3_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test4_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test5_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test6_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test7_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test8_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set test9_ip6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 1h; }
    set blackhole_ipv6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 48h; }
    set ports_used6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ports_tested6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set sports_tested6 { typeof tcp sport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ports_contacted6 { typeof tcp dport; flags dynamic, timeout; size 65536; timeout 48h; }
    set ip_contacted6 { type ipv6_addr; flags dynamic, timeout; size 65536; timeout 48h; }

	chain input {
		type filter hook input priority 0;
		iif "lo" accept # accept any localhost traffic
		ct state established,related counter accept # accept established connections
		icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-request, echo-reply, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, 148, 149 } counter accept # ICMPv6 packets which must not be dropped, see https://tools.ietf.org/html/rfc4890#section-4.4.1
		ip6 saddr fe80::/10 icmpv6 type { 130, 131, 132, 143, 151, 152, 153 } counter accept
		limit rate over 20/hour add @ports_used6 { tcp dport } counter # port statistics in hours with more than 20 test.
		ip6 saddr and ffff:ffff:ffff:ffff:: @blackhole_ipv6 counter drop # IP already flagged as black hole.
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test1_ip6 add @test1_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept # any IPv6 range is allowed nine tests in last hours before blackhole_ipv6. We only accept nine new ssh connections for any IPv6 range.
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test1_ip6 add @test1_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test2_ip6 add @test2_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test2_ip6 add @test2_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test3_ip6 add @test3_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test3_ip6 add @test3_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test4_ip6 add @test4_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test4_ip6 add @test4_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test5_ip6 add @test5_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test5_ip6 add @test5_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test6_ip6 add @test6_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test6_ip6 add @test6_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test7_ip6 add @test7_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test7_ip6 add @test7_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test8_ip6 add @test8_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test8_ip6 add @test8_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		tcp dport 22 ct state new ip6 saddr and ffff:ffff:ffff:ffff:: != @test9_ip6 add @test9_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter accept
		ip6 saddr and ffff:ffff:ffff:ffff:: != @test9_ip6 add @test9_ip6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop
		add @ports_tested6 { tcp dport } counter # port statistics from IPv6 ranges making more than 9 tests in last hour
		add @sports_tested6 { tcp sport } counter # source port statistics from IPv6 ranges making more than 9 tests in last hour
		add @blackhole_ipv6 { ip6 saddr and ffff:ffff:ffff:ffff:: } counter drop # now only those already in the nine sets remain, adding them to blackhole_ipv6
	}
	chain forward {
		type filter hook forward priority 0;
	}
	chain output {
		type filter hook output priority 0;
		add @ports_contacted6 { tcp dport } counter # output port statistics
		add @ip_contacted6 { ip6 daddr } # output port statistics
	}
}
